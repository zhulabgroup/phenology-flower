
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
source("code/prep_setup.R")
```

```{r, eval=TRUE}
source("code/prep_scope.R")
```

* Taxa of interest are based on [Description and allergenic potential of 11 most important pollen taxa in the CUSSC region ranked by percent abundance relative to the sum of all pollen taxa over 31 NAB stations that meet inclusion criteria, 2003â€“2017] (https://link.springer.com/article/10.1007/s10453-019-09601-2/tables/2)
* Spring- and fall-flowering elms are treated separately as suggested by Allison and Yingxiao.
* I decide to separate grasses into early and late-flowering groups as well because many cities have two pollen peaks.
```{r, eval=TRUE}
taxa_list
```

* Eight major cities in CONUS with pollen count data and street tree inventory.
* Detroit also has info of oak trees with ground observed flowering phenology.
```{r, eval=TRUE}
sitename_list
```

* Focus on the life cycles from 2018 to 2021, spanning 2017 and 2022.
```{r, eval=TRUE}
year_list
```

# Data
## NAB data
### Read and clean data
```{r, eval=FALSE}
source("code/data_nab_read.R")
```

### Resolve taxonomy
```{r, eval=FALSE}
source("code/data_nab_taxa.R")
```

Combine nab data and taxa information. Some preprocessing.
```{r, eval=TRUE}
source("code/data_nab_join.R")
```

Focus on ten cities.
* Exceptions: Denver pollen data are from Colorado Springs; Austin pollen data are from Georgetown; Detroit pollen data are from Sylvania.
```{r, eval=TRUE}
source("code/data_nab_meta.R")
p_pollen_map
```

View pollen phenology in study sites.
```{r, eval=TRUE}
source("code/data_nab_pheno.R")
p_nab_calen
```

## Plant location data
### Tree inventory
Read in and clean data. Each tree inventory has a different format, so they have to be processed differently.
```{r, eval=FALSE}
source("code/data_occ_tree_read.R")
```

Find family names from genus names. This step needs supervision.
```{r, eval=FALSE}
source("code/data_occ_tree_taxa.R")
```

### Grass patch
```{r, eval=FALSE}
source("code/data_occ_grass.R")
```

### Ragweed observation
Get ragweed occurrence information from GBIF.
```{r, eval=FALSE}
source("code/data_occ_ragweed.R")
```

### View plant occurrence data

Put tree, grass, and ragweed data in one data frame.
```{r, eval=TRUE}
source("code/data_occ_join.R")
```

Map relative position of tree inventory and nab station.
```{r, eval=TRUE}
source("code/data_occ_map.R")
p_nab_plant_map
```

Calculate distance from plants to NAB stations in the unit of km.
```{r, eval=TRUE}
source("code/data_occ_dist.R")
distance_df
```

Prepare street map as basemap. Street shapefiles for major cities manually downloaded from https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/CUWWYJ.
Boeing, Geoff, 2017, "U.S. Street Network Shapefiles, Node/Edge Lists, and GraphML Files", https://doi.org/10.7910/DVN/CUWWYJ, Harvard Dataverse, V2
```{r, eval=FALSE}
roads_files_all <- list.files("./data/occurrence/roads/", pattern = "edges.shp", recursive = T, full.names = T)

# cl <- makeCluster(length(site_list), outfile = "")
# registerDoSNOW(cl)
roads_fort_list <- vector(mode = "list")

for (
  s in 1:length(site_list)
) {
  # read shapefile for the site
  siteoi <- site_list[s]
  sitename <- sitename_list[s]
  roads_file <- str_subset(roads_files_all, pattern = sitename %>% str_replace(" ", "_"))
  roads <- readOGR(dsn = roads_file)

  # get boundary from plant occurrence data frame
  plant_df_site <- plant_df %>% filter(site == siteoi)
  area_site <- extent(min(plant_df_site$lon) - 0.005, max(plant_df_site$lon) + 0.005, min(plant_df_site$lat) - 0.005, max(plant_df_site$lat) + 0.005)
  area_site <- as(area_site, "SpatialPolygons")
  proj4string(area_site) <- CRS(proj4string(roads))

  # clip the shapefile
  rgeos::set_RGEOS_CheckValidity(2L)
  roads_crop <- gIntersection(roads, area_site, byid = TRUE)

  # transform into a format that can be used in ggplot
  roads_sldf <- SpatialLinesDataFrame(roads_crop, data = data.frame(value = rep(1, length(roads_crop))), match.ID = F)
  roads_fort <- roads_sldf %>%
    fortify() %>%
    mutate(
      site = siteoi,
      sitename = sitename
    )

  roads_fort_list[[s]] <- roads_fort
}
roads <- bind_rows(roads_fort_list)
stopCluster(cl)
write_rds(roads, "./data/occurrence/roads/roads_cities.rds")
```

Map plant occurrence in each city.
```{r, eval=FALSE, fig.width=12, fig.height=30}
roads <- read_rds("./data/occurrence/roads/roads_cities.rds")

extent_df <- plant_df %>%
  group_by(site) %>%
  summarise(
    minlon = min(lon),
    minlat = min(lat),
    maxlon = max(lon),
    maxlat = max(lat)
  )

p_plant_map <- ggplot() +
  theme_void() +
  geom_line(
    data = roads %>%
      filter(site %in% c("NY")) %>%
      left_join(extent_df, by = "site") %>%
      group_by(site) %>%
      mutate(
        long = (long - (maxlon + minlon) / 2) / max((maxlon - minlon), (maxlat - minlat)),
        lat = (lat - (maxlat + minlat) / 2) / max((maxlon - minlon), (maxlat - minlat))
      ) %>%
      ungroup(),
    aes(x = long, y = lat, group = group), size = .2, alpha = 0.5
  ) +
  geom_point(
    data = plant_df %>%
      filter(site %in% c("NY")) %>%
      filter(genus %in% taxa_short_list | family %in% taxa_short_list) %>%
      mutate(taxa = case_when(
        family %in% c("Poaceae", "Cupressaceae", "Pinaceae") ~ family,
        TRUE ~ genus
      )) %>%
      filter(!taxa %in% c("Poaceae", "Ambrosia")) %>%
      group_by(taxa, site) %>%
      sample_n(min(100, n())) %>%
      ungroup() %>%
      left_join(meta_df %>% dplyr::select(site, sitename), by = "site") %>%
      left_join(extent_df, by = "site") %>%
      group_by(site) %>%
      mutate(
        lon = (lon - (maxlon + minlon) / 2) / max((maxlon - minlon), (maxlat - minlat)),
        lat = (lat - (maxlat + minlat) / 2) / max((maxlon - minlon), (maxlat - minlat))
      ) %>%
      ungroup(),
    aes(x = lon, y = lat, col = taxa), alpha = 0.3
  ) +
  facet_wrap(. ~ sitename, ncol = 1) +
  guides(col = guide_legend(title = "Taxa")) +
  theme(legend.position = "bottom") +
  # ylab("Latitude")+
  # xlab("Longitude")+
  coord_equal()
p_plant_map
```

## NPN data
```{r, eval=FALSE}
source("code/data_npn_down.R")
```

View flowering phenology (from NPN data) in study sites.
```{r, eval=TRUE}
source("code/data_npn_pheno.R")
p_npn_calen
```

## CHELSA data
```{r, eval=TRUE}
source("code/data_chelsa.R")
chelsa_df
```

## PlanetScope data
### Order

```{r, eval=TRUE, echo=FALSE}
source("code/data_ps_patch.R")
```

User settings.
```{r, eval=TRUE}
source("code/data_ps_setup.R")
```

Order data.
```{r, eval=FALSE}
source("code/data_ps_order.R")
```

### Download
```{r, eval=FALSE}
source("code/data_ps_down.R")
```

### Retrieve time series at plant locations
```{r, eval=FALSE}
source("code/data_ps_ts.R")
```

Example time series.
```{r, eval=TRUE}
source("code/data_ps_check.R")
p_ps_ref
```

Compare EVI time series between taxa.
```{r, eval=TRUE}
p_ps_taxa
```

Compare EVI time series between different oak species in Austin.
```{r, eval=TRUE}
p_ps_species
```
