--- 
title: "Detecting flowering events of pollen-producing plants with high spatial resolution imagery"
author: "Yiluan Song"
date: "`r format(Sys.time(), '%B %d, %Y')`"
site: bookdown::bookdown_site
output: bookdown::html_document2
editor_options: 
  chunk_output_type: console
documentclass: book
bibliography: [book.bib]
biblio-style: apalike
link-citations: yes
---


# Manuscript draft{-}

```{r, echo = F}
knitr::include_url("https://docs.google.com/document/d/1SPaFdOFUa9GVW4iWna1e43tHQl1Vef6MpXRW1o6DbFo/edit?usp=sharing")
```

Show session information.

```{r}
sessionInfo()
```

```{r, eval=FALSE, echo=FALSE}
rsconnect::connectUser(server = 'bookdown.org')
```


<!--chapter:end:index.Rmd-->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
source("code/prep_setup.R")
```

```{r, eval=TRUE}
source("code/prep_scope.R")
```

* Taxa of interest are based on [Description and allergenic potential of 11 most important pollen taxa in the CUSSC region ranked by percent abundance relative to the sum of all pollen taxa over 31 NAB stations that meet inclusion criteria, 2003â€“2017] (https://link.springer.com/article/10.1007/s10453-019-09601-2/tables/2)
* Spring- and fall-flowering elms are treated separately as suggested by Allison and Yingxiao.
* I decide to separate grasses into early and late-flowering groups as well because many cities have two pollen peaks.
```{r, eval=TRUE}
v_taxa
```

* Eight major cities in CONUS with pollen count data and street tree inventory.
* Detroit also has info of oak trees with ground observed flowering phenology.
```{r, eval=TRUE}
v_site_name
```

* Focus on the life cycles from 2018 to 2021, spanning 2017 and 2022.
```{r, eval=TRUE}
v_year
```

# Data
## NAB data
### Read and clean data
```{r, eval=FALSE}
source("code/data_nab_read.R")
```

### Resolve taxonomy
```{r, eval=FALSE}
source("code/data_nab_taxa.R")
```

Combine nab data and taxa information. Some preprocessing.
```{r, eval=TRUE}
source("code/data_nab_join.R")
```

Focus on ten cities.
* Exceptions: Denver pollen data are from Colorado Springs; Austin pollen data are from Georgetown; Detroit pollen data are from Sylvania.
```{r, eval=TRUE}
source("code/data_nab_meta.R")
p_pollen_map
```

View pollen phenology in study sites.
```{r, eval=TRUE}
source("code/data_nab_pheno.R")
p_nab_calen
```
```{r}
source("code/data_nab_window.R")
p_flower_window
```

## Plant location data
### Tree inventory
Read in and clean data. Each tree inventory has a different format, so they have to be processed differently.
```{r, eval=FALSE}
source("code/data_occ_tree_read.R") #test
```

Find family names from genus names. This step needs supervision.
```{r, eval=FALSE}
source("code/data_occ_tree_taxa.R") #test
```

### Grass patch
```{r, eval=FALSE}
source("code/data_occ_grass.R") # test
```

### Ragweed observation
Get ragweed occurrence information from GBIF.
```{r, eval=FALSE}
source("code/data_occ_ragweed.R") # test
```

### View plant occurrence data

Put tree, grass, and ragweed data in one data frame.
```{r, eval=TRUE}
source("code/data_occ_join.R")
```

Map relative position of tree inventory and nab station.
```{r, eval=TRUE}
source("code/data_occ_map.R")
p_nab_plant_map
```

Calculate distance from plants to NAB stations in the unit of km.
```{r, eval=TRUE}
source("code/data_occ_dist.R")
df_distance
```

Prepare street map as basemap. Street shapefiles for major cities manually downloaded from https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/CUWWYJ.
Boeing, Geoff, 2017, "U.S. Street Network Shapefiles, Node/Edge Lists, and GraphML Files", https://doi.org/10.7910/DVN/CUWWYJ, Harvard Dataverse, V2
```{r, eval=FALSE}
source("code/data_occ_road_read.R") # test
```

Map plant occurrence in a city.
```{r, eval=TRUE, fig.width=12, fig.height=30}
source("code/data_occ_road_map.R")
p_plant_map
```

## NPN data
```{r, eval=FALSE}
source("code/data_npn_down.R") # test
```

View flowering phenology (from NPN data) in study sites.
```{r, eval=TRUE}
source("code/data_npn_pheno.R")
p_npn_calen
```

## CHELSA data
```{r, eval=TRUE}
source("code/data_chelsa.R")
df_chelsa
```

## PlanetScope data
### Order

```{r, eval=TRUE, echo=FALSE}
source("code/func_ps_patch.R")
```

Order data.
```{r, eval=FALSE}
source("code/data_ps_order.R")
```

### Download
```{r, eval=FALSE}
source("code/data_ps_down.R")
```

### Retrieve time series at plant locations
```{r, eval=FALSE}
source("code/data_ps_ts.R") # test
```

Time series preprocessing.
```{r, eval=TRUE}
source("code/func_proc_ps.R")
```

Check PS data.
Compare EVI time series between different oak species.
Compare EVI time series between genus/family.

```{r, eval = TRUE}
source("code/data_ps_snap.R")
p_ps_snap

source("code/data_ps_check.R")
p_ps_ref
```


Some settings.
```{r, eval=TRUE}
source("code/prep_hyper.R")
```

Is there even a typical phenological curve? This is a function to rule out curves that are flat.
```{r, eval=TRUE}
source("code/func_flat.R")
```

```{r, eval=TRUE}
source("code/data_rank.R")
p_ts_ps_indi
p_rank_ps_indi
p_ts_ps_sp
p_rank_ps_sp
p_ts_ps_taxa
p_rank_ps_taxa
```

<!--chapter:end:01-data.Rmd-->

```{r}
source("code/neon_data_pheno.R")
p_neon_map
```
```{r}
source("code/neon_leaf_flower.R")
p_neon_leaf_flower
```

```{r}
source("code/neon_data_ps.R")
source("code/neon_snap.R")
p_ps_snap
```

```{r}
source("code/neon_corr.R")
p_neon_ps_corr_flower
p_neon_ps_corr_leaf
```

```{r}
source("code/neon_rank.R")
p_rank_neon_flower
p_rank_neon_leaf
p_rank_ps_neon
df_rank_compare_summ
```

<!--chapter:end:02-neon.Rmd-->

# Correlation betwen leafing and flowering phenology on individual level

## Compare with individual flowering observations (Detroit oaks) 
Trees in detroit.
```{r, eval=TRUE}
source("code/indi_meta.R")
p_dt_map
```

Flowering observations.
```{r, eval=TRUE}
source("code/indi_flower.R")
p_dt_flower
```

View EVI, NAB, and NPN data together for one tree.
```{r, eval=TRUE}
source("code/indi_join.R")
p_dt_join
```

Detect greenup at multiple thresholds.
```{r, eval=TRUE}
source("code/func_doy.R")
```

```{r, eval=TRUE}
source("code/func_plot_tree.R")
```

```{r, eval=TRUE}
source("code/indi_doy.R")
p_dt_doy_one
```

Plot four trees as example.
```{r}
p_dt_doy_mult
```

Repeat for all trees. Plot green-up doy at several thresholds vs. flower observations. (Only showing within the limit of day 110 to 160.)
```{r, eval=TRUE}
source("code/indi_corr.R")
p_dt_corr_2017
```

Repeat for all years and check correlation. Here only showing green-up at 50%. There were significantly positive correlations in three out of five years, suggesting that green-up and flowering time may be correlated on the individual level.
```{r, eval=TRUE}
p_dt_corr_years
```

Get frequency distribution of green-up dates.
```{r, eval=TRUE}
source("code/indi_freq.R")
p_dt_freq
```


<!--chapter:end:03-detroit.Rmd-->

# Match pollen phenology with leafing phenology
Conceptual figure.
```{r, eval=TRUE}
source("code/city_concept.R")
p_conceptual
```

## Characterize leafing phenology for all taxa and cities
```{r, eval=FALSE}
source("code/city_doy.R")
source("code/city_freq.R")
```

## Tune threshold and time lag with pollen data
```{r, eval=FALSE}
source("code/city_tune.R")
```

## Results
Prepare for Shiny app by copying result figures to the current folder. Shiny app code is in ./shinyapp/app.R. Needs to deploy app once every time results are changed.
```{r, eval=FALSE}
source("code/city_shiny.R")
```

Display results in a Shiny app.
```{r, eval=TRUE, cache=FALSE}
knitr::include_app("https://yiluansong.shinyapps.io/RS4flower_result/", height = "600px")
```

Visualize matching results for all taxa in New York.
```{r, eval=TRUE}
source("code/city_plot_subset.R")
p_comp_1city
p_comp_1taxa
p_comp_1taxa2city
```

<!--chapter:end:04-match.Rmd-->

# Infer relationship between leaf-flower lag with climate

Plot correlation between mean annual temperature (MAT) and lag between green-up/down frequency and pollen count.
* A positive lag means leafing phenology leads pollen phenology; a negative lag means leafing phenology lags pollen phenology.
```{r, eval=TRUE}
source("code/clim_plot.R")
p_lag_clim
```
Linear regression to check significance of the correlation. When looking at individual taxa, only 3 were statistically significant.
```{r, eval=TRUE}
source("code/clim_reg.R")
p_slope
```

Linear mixed-effect model with random slope and random intercept to summarize correlation over early and late flowering taxa.
* For early-flowering taxa, pollen phenology usually leads leafing phenology. At warmer places, pollen leads leafing even more. This effect was statistically significant.
* For early-flowering taxa, pollen phenology usually lags leafing phenology. At warmer places, pollen lags green-down even more. This effect was not statistically significant, possibly because there were only three taxa. It was significant for late-flowering elm trees.

```{r,eval=TRUE}
summary(fit_lme)
```

<!--chapter:end:05-climate.Rmd-->

# Leave-one-out cross validation

We conducted leave-one-out cross validation to test the robustness of the climate-phenology relationship and the effectiveness of using it to infer flowering phenology in new locations. Specifically, we removed a random city from the pollen dataset at a time, matched leafing and pollen phenology in the other cities, and modeled the climate-lag correlation. We predicted the leafing-phenology lag with the linear model and subsequently predicted the flowering phenology from known leafing phenology at the city held for validation. We evaluated the accuracy of our methods by calculating the RMSE between the predicted flowering phenology and standardized pollen count observations at the cities held for validation.

```{r, eval=FALSE}
source("code/loocv_tune.R")
```

Read in climate-lag relationship and fit LME models.
```{r, eval=TRUE}
source("code/loocv_lme.R")
```

Read in validation results and visualize.
```{r, eval=TRUE}
source("code/loocv_fit.R")
tb_rmse_out
p_rmse_taxa
# p_rmse_quercus
wtest2
```


<!--chapter:end:06-loocv.Rmd-->

# Manuscript display items

## Methodology
```{r, eval=TRUE, fig.width=16, fig.height=16, fig.cap="Approach for detecting pollen phenology from remotely-sensed leafing phenology. Enhanced vegetation index (EVI) time series of individual trees are used to determine green-up/down days at various green-up/down thresholds. The green-up/down days were then summarized to the site level as green-up/down frequencies. The green-up/down frequencies were compared with time series of pollen count (squareroot-transformed). For each taxa and across all sites, the green-up/down threshold that lead to the best match in the shapes of leafing and pollen phenology curves was chosen. For each site specifically, the best lag between leafing and pollen phenology curves were chosen."}
p_conceptual
```

## Data
```{r, eval=TRUE, fig.width=12, fig.height=12, fig.cap="Pollen count and plant occurrence data. (A) Map of pollen counting stations associated with the National Allergy Bureau (NAB) and plant records near selected pollen counting stations. All pollen counting stations are marked in crossed circles, with ten selected stations in this study highlighted in red. Plant occurrence data from street tree inventory, land cover classification, and crowdsourcing are marked in blue points. (B) Pollen phenology of eleven key pollen-producing taxa in ten selected stations. (C) Spatial distribution of pollen-producing plants at ten study sites. Basemap show streets in cities. For simplicity, random 200 plants are visualized for each site."}

source("code/fig_data.R")  
p_main_data
```

## NEON
```{r, eval=TRUE, fig.width=10, fig.height=10, fig.cap="Individual phenological observations extracted from PlanetScope (PS) and National Ecological Observatory Network (NEON) for wind-pollinated taxa. (A) Correlation between leafing and flowering phenology in NEON observations. (B) Correlation between 50% green-up time from PS and flowering time from NEON. (C) Correlation between 50% green-up time from PS in 2018 and 2019."}
source("code/fig_neon.R")
p_main_neon
```

## Detroit
```{r, eval=TRUE, fig.width=12, fig.height=8, fig.cap="Correlation between leafing and flowering phenology on the individual level. (A) Enhanced vegetation index (EVI) (green points) are used to calculate the green-up days at different thresholds (red lines), compared with flower observations for selected oak trees in Detroit, crowdsourced flower observations, and pollen count. (B) Correlation between green-up days and observed flowering days (first day exceeding 95% flowering) for different green-up thresholds. (C) Correlation between 50% green-up days in five years and observed flowering days (first day exceeding 95% flowering) in 2017."}
source("code/fig_indi.R")
p_main_indi
```

## All cities and taxa
```{r, eval=TRUE, fig.width=10, fig.height=6, fig.cap="Comparing pollen phenology from remote sensing and aerial sampling. Pollen phenology inferred from remotely-sensed leafing phenology tuned to the optimal green-up/down thresholds and leafing-pollen lags are shown in lines. Pollen phenology from airborne pollen concentration (squareroot-transformed) are shown in points. Pollen phenology from both data sources was converted to frequency density within each site year for comparison."}
source("code/fig_city.R")
p_main_city
```

## Climate
```{r, eval=TRUE, fig.width=12, fig.height=6, fig.cap="Effect of climate on pollen phenology. (A) Relationship between leafing-pollen phenology lag (day) and mean annual temperature (MAT) (Â°C) for each taxa. (B) Slope of linear regression, with taxa separated into early- and late- flowering groups."}
source("code/fig_clim.R")
p_main_clim
```

## Validation
```{r, eval=TRUE, fig.width=12, fig.height=6, fig.cap="Accuracy of standardized pollen count predicted from climatology, PlanetScope EVI (using data from all cities), and PlanetScope EVI (using data from all cities except the one being predicted), summarized by (A) taxa and (B) city."}
source("code/fig_loocv.R")
p_main_loocv
```

<!--chapter:end:07-figures.Rmd-->

