# Match pollen phenology with leafing phenology
Conceptual figure.
```{r, eval=TRUE}
conceptual1<-image_read("/raid/users/ysong67/GitHub/phenology/RS4flower/output/figures/conceptual1.jpg")
p_conceptual1<-image_ggplot(conceptual1)
conceptual2<-image_read("/raid/users/ysong67/GitHub/phenology/RS4flower/output/figures/conceptual1.jpg")
p_conceptual2<-image_ggplot(conceptual2)
grid.arrange(p_conceptual1, p_conceptual2, ncol=1)
```

## Characterize leafing phenology for all taxa and cities
```{r, eval=FALSE}
cl <- makeCluster(50, outfile = "")
registerDoSNOW(cl)

for (taxaoi in taxa_list) {
  taxaoi_short<-str_split(taxaoi, " ", simplify = T)[1]
  flower_window<-seq(flower_window_df %>% filter(taxa==taxaoi) %>% pull(start),
                     flower_window_df %>% filter(taxa==taxaoi) %>% pull(end),
                     by=1)
  if (taxaoi %in% c("Ambrosia", "Ulmus late")) {
    thres_df_taxa<-thres_df %>% filter(direction=="down")
  } else if (taxaoi== "Poaceae early"  ) {
    thres_df_taxa<-thres_df %>% filter(threshold>=0.5|direction=="up")
  } else if (taxaoi== "Poaceae late"  ) {
    thres_df_taxa<-thres_df %>% filter(threshold>=0.5|direction=="down")
  } else {
    thres_df_taxa<-thres_df %>% filter(direction=="up")
  }
  flower_doy_df_siteyears_list<-flower_freq_df_siteyears_list<-vector(mode="list", length=length(site_list))
  for (s in 1:length(site_list)) {
    siteoi<-site_list[s]
    plant_taxa_df<-plant_df %>% 
      filter(site==siteoi) %>% 
      filter(genus==taxaoi_short|family==taxaoi_short) %>% 
      mutate(id=row_number()) %>% 
      drop_na(lon, lat)
    
    plant_df %>%
      filter(site==siteoi) %>%
      filter(genus==taxaoi_short|family==taxaoi_short) %>%
      group_by(species) %>%
      summarise(n=n()) %>%
      ungroup() %>%
      arrange(desc(n))
    
    if (taxaoi %in% c("Ambrosia","Poaceae")) {
      min_sample_size=10
    } else {
      min_sample_size=20
    }
    
    if (nrow(plant_taxa_df)>=min_sample_size) {
      set.seed(1)
      random_id<<-sample(plant_taxa_df$id, min(2000, length(unique(plant_taxa_df$id)))) %>% sort()
      
      # preprocess ps data
      ps_df<-read_rds(paste0(ps_path, "analyses/ps_",siteoi,"_",taxaoi_short,".rds")) 
      ps_df_proc<- ps_df%>% 
        drop_na() %>% 
        filter(id%in% random_id) %>%
        mutate(date=as.Date(time)) %>% 
        mutate(year=format(time, "%Y") %>% as.integer(),
               doy=format(time, "%j") %>% as.integer(),
               hour=format(strptime(time,"%Y-%m-%d %H:%M:%S"),'%H') %>% as.integer()) %>% 
        filter(qa==0) %>%
        group_by(id, lon, lat, date, year, doy ) %>% 
        summarise(blue=mean(blue),
                  green=mean(green),
                  red=mean(red),
                  nir=mean(nir)) %>% 
        ungroup() %>% 
        mutate(evi=2.5* (nir-red) / (nir + 6*red - 7.5*blue + 1)) %>% 
        filter(evi>0, evi<=1) %>% 
        filter(red>0, green>0, blue>0) 
      
      # subset nab data
      pollen_df<- nab_with_taxa_df %>% 
        left_join(meta_df %>% dplyr::select(id, site), by="id") %>% 
        filter(site==siteoi) %>% 
        filter(genus==taxaoi_short|family==taxaoi_short) 
      
      # subset npn data
      npn_df<-npn_df_all %>% 
        filter(site==siteoi) %>% 
        filter(taxa==taxaoi_short)
      
      ts_df<-ps_df_proc %>% 
        left_join(plant_taxa_df, by=c("id", "lon", "lat")) %>% 
        
        dplyr::select(id, date, `EVI (PS)`=evi #, 
                      # `G2R (PS)`=g2r, `EBI (PS)`=ebi
                      ) %>% 
        mutate(id=as.factor(id)) %>% 
        full_join(pollen_df %>% 
                    dplyr::select(date, `pollen count (NAB)`=count) %>% 
                    mutate(id="pollen") , 
                  by=c("date", "id") ) %>% 
        full_join(npn_df %>%
                    dplyr::select(date, `flower observation (USA-NPN)`=count) %>%
                    mutate(id="npn") ,
                  by=c("date", "id") ) %>%
        arrange(id, date) %>% 
        mutate(doy=format(date, "%j") %>% as.numeric()) %>% 
        mutate(year=format(date, "%Y") %>% as.numeric()) 
      
      flower_doy_df_years_list<-flower_freq_df_years_list<-vector(mode="list", length=length(year_list))
      for (y in 1:length(year_list)) {
        yearoi<-year_list[y]
        ts_df_subset<-ts_df %>% 
          filter(doy!=366) %>% 
          filter(year==yearoi|year==(yearoi-1)|year==(yearoi+1)) %>% 
          mutate(doy=ifelse(doy>273& year==yearoi-1, doy-365, doy)) %>% 
          mutate(year=ifelse(doy<=0 & year==yearoi-1, year+1, year)) %>% 
          mutate(doy=ifelse(doy<152& year==yearoi+1, doy+365, doy)) %>% 
          mutate(year=ifelse(doy>365 & year==yearoi+1, year-1, year)) %>% 
          filter(year==yearoi) %>% 
          gather(key="var", value="value", -date, -id, -doy, -year ) %>% 
          mutate(var=fct_relevel(var, levels=c( "EVI (PS)", "G2R (PS)","EBI (PS)", "pollen count (NAB)", "flower observation (USA-NPN)"))) %>% 
          mutate(alpha=case_when(var %in% c("EVI", "G2R")~0.05,
                                 TRUE~1)) %>% 
          arrange(doy)
        
        ts_df_subset_summary<- ts_df_subset%>%
          drop_na(value) %>%
          group_by(date, var, doy, year) %>%
          summarise(q1=quantile(value, 0.05, na.rm=T),
                    q2=quantile(value, 0.5, na.rm=T),
                    q3=quantile(value, 0.95, na.rm=T),
                    n=n()) %>%
          filter(n>1) %>%
          ungroup()
        
        flower_df_list<-
          foreach (i = 1:length(random_id),
                   .packages = c("tidyverse", "ptw","greenbrown", "EnvCpt","segmented", "RhpcBLASctl"))  %dopar% {
                     blas_set_num_threads(1)
                     omp_set_num_threads(1)
                     
                     debug=F
                     idoi <-  as.character(random_id)[i]
                     
                     if (debug) { 
                       set.seed(NULL)
                       idoi<-sample(random_id,1) %>% as.character()
                     }
                     
                     flower_df<-get_doy(plant_taxa_df,thres_df_taxa, ts_df_subset, idoi)
                     
                     if (debug) {
                       p_1tree<-plot_tree(plant_taxa_df, ts_df_subset, flower_df, idoi)
                     }
                     
                     print(paste0(i , " out of ", length(random_id)))
                     flower_df
                   }
        flower_doy_df<-bind_rows(flower_df_list) %>% 
          left_join(plant_taxa_df %>% dplyr::select(id, species, lat, lon) %>% mutate(id=as.character(id)), by="id") %>% 
          mutate(site=siteoi, year=yearoi)
        
        flower_freq_df_list<-vector(mode="list", length=nrow(thres_df_taxa))
        for (t in 1:nrow(thres_df_taxa)) {
          flower_freq_df_list[[t]]<-flower_doy_df %>% 
            drop_na(start, end) %>% 
            filter(direction==thres_df_taxa$direction[t],
                   thres==thres_df_taxa$threshold[t]) %>% 
            group_by(doy, thres,direction) %>%
            summarise(count=n()) %>%
            ungroup() %>% 
            mutate(freq=count/n())
        }
        flower_freq_df<-bind_rows(flower_freq_df_list)
        
        
        flower_freq_df<-flower_freq_df %>% 
          mutate(doy=factor(doy, levels=c((274-365):(365+151))) ) %>% 
          complete(doy, thres,direction,fill=list(count=0,freq=0)) %>%
          mutate(doy=doy %>% as.character() %>% as.numeric()) %>% 
          arrange(doy) %>% 
          full_join(ts_df_subset %>% 
                      filter(id=="pollen") %>% 
                      filter(var=="pollen count (NAB)") %>% 
                      filter(year==yearoi) %>% 
                      dplyr::select( doy, pollen=value),
                    by="doy") %>% 
          full_join(ts_df_subset %>%
                      filter(id=="npn") %>%
                      filter(var=="flower observation (USA-NPN)") %>%
                      filter(year==yearoi) %>%
                      dplyr::select( doy, npn=value),
                    by="doy") %>%
          full_join(ts_df_subset_summary %>% 
                      filter(var=="EVI (PS)") %>% 
                      filter(year==yearoi) %>% 
                      dplyr::select( doy, evi=q2),
                    by="doy"
          ) %>% 
          full_join(ts_df_subset_summary %>% 
                      filter(var=="G2R (PS)") %>% 
                      filter(year==yearoi) %>% 
                      dplyr::select( doy, g2r=q2),
                    by="doy"
          ) %>% 
          mutate(doy=as.numeric(doy)) %>% 
          mutate(site=siteoi, year=yearoi) %>% 
          drop_na(doy, thres)
        
        print(paste0(siteoi, ", ", yearoi))
        
        flower_doy_df_years_list[[y]]<-flower_doy_df 
        flower_freq_df_years_list[[y]]<-flower_freq_df
      }
      flower_doy_df_siteyears_list[[s]]<-bind_rows(flower_doy_df_years_list)
      flower_freq_df_siteyears_list[[s]]<-bind_rows(flower_freq_df_years_list)
    }
  }
  flower_doy_df<-bind_rows(flower_doy_df_siteyears_list) %>% 
    left_join(data.frame(site=site_list, sitename=sitename_list
                         # , region=region_list
                         ), by=c("site"))
  
  flower_freq_df<-bind_rows(flower_freq_df_siteyears_list) %>% 
    group_by(site, year,thres,direction) %>% 
    mutate(freq_sm=whit1(freq, 30)) %>% 
    mutate(pollen_in=na.approx(pollen, doy, na.rm=F, maxgap=14)) %>%  
    mutate(pollen_fill=replace_na(pollen_in, 0)) %>%
    mutate(pollen_sm=whitfun(pollen_fill,30)) %>%  
    ungroup() %>% 
    dplyr::select(-pollen_in, -pollen_fill) %>% 
    mutate(pollen=case_when(doy %in% flower_window~ pollen)) %>% 
    mutate(pollen_sm=case_when(doy %in% flower_window~ pollen_sm,
                               TRUE~0)) %>% 
    mutate(npn=case_when(doy %in% flower_window~ npn))
  
  # pollen climatology (historical mean of smoothed pollen count)
  pollen_clim<-flower_freq_df %>% 
    group_by(site,direction, thres,doy) %>%
    summarise(pollen_clim=mean(pollen_sm, na.rm=T)) 
  
  flower_freq_df<-flower_freq_df%>% 
    left_join(pollen_clim, by=c("site",  "direction","thres", "doy")) %>% 
    left_join(data.frame(site=site_list, sitename=sitename_list
                         # , region=region_list
                         ), by=c("site"))
  
  
  output_path<-paste0("/raid/users/ysong67/GitHub/phenology/RS4flower/output/data/", taxaoi,"/")
  dir.create(output_path, recursive = T)
  write_rds(flower_doy_df,paste0(output_path,"flowering day of year.rds" ))
  write_rds(flower_freq_df,paste0(output_path,"flowering frequency.rds" ) )
}
stopCluster(cl)
```

## Tune threshold and time lag with pollen data
```{r, eval=FALSE}
cl <- makeCluster(50, outfile = "")
registerDoSNOW(cl)
for (taxaoi in taxa_list) {
  taxaoi_short<-str_split(taxaoi, " ", simplify = T)[1]
  flower_window<-seq(flower_window_df %>% filter(taxa==taxaoi) %>% pull(start),
                     flower_window_df %>% filter(taxa==taxaoi) %>% pull(end),
                     by=1)
  if (taxaoi %in% c("Ambrosia", "Ulmus late")) {
    thres_df_taxa<-thres_df %>% filter(direction=="down")
  } else if (taxaoi== "Poaceae early"  ) {
    thres_df_taxa<-thres_df %>% filter(threshold>=0.5|direction=="up")
  } else if (taxaoi== "Poaceae late"  ) {
    thres_df_taxa<-thres_df %>% filter(threshold>=0.5|direction=="down")
  } else {
    thres_df_taxa<-thres_df %>% filter(direction=="up")
  }
  
  output_path<-paste0("/raid/users/ysong67/GitHub/phenology/RS4flower/output/data/", taxaoi,"/")
  
  # read in leafing phenology data
  flower_doy_df<-read_rds(paste0(output_path,"flowering day of year.rds" ))
  flower_freq_df<-read_rds(paste0(output_path,"flowering frequency.rds" ) )
  
  # standardize all data to be between 0 and 1
  flower_freq_df_standard<-flower_freq_df %>% 
    mutate(pollen=pollen %>% sqrt()) %>%
    mutate(pollen_sm=pollen_sm %>% sqrt()) %>%
    mutate(pollen_clim=pollen_clim %>% sqrt()) %>%
    group_by(site, sitename, thres) %>%
    mutate(freq=(freq-min(freq, na.rm = T))/(max(freq, na.rm = T)-min(freq, na.rm = T))) %>% 
    mutate(freq_sm=(freq_sm-min(freq_sm, na.rm = T))/(max(freq_sm, na.rm = T)-min(freq_sm, na.rm = T))) %>% 
    mutate(pollen=(pollen-min(pollen, na.rm = T))/(max(pollen, na.rm = T)-min(pollen, na.rm = T))) %>%
    mutate(pollen_clim=(pollen_clim-min(pollen_sm, na.rm = T))/(max(pollen_sm, na.rm = T)-min(pollen_sm, na.rm = T))) %>% 
    mutate(pollen_sm=(pollen_sm-min(pollen_sm, na.rm = T))/(max(pollen_sm, na.rm = T)-min(pollen_sm, na.rm = T))) %>% 
    mutate(npn=(npn-min(npn, na.rm = T))/(max(npn, na.rm = T)-min(npn, na.rm = T))) %>%
    mutate(evi=(evi-min(evi, na.rm = T))/(max(evi, na.rm = T)-min(evi, na.rm = T))) %>% 
    mutate(g2r=(g2r-min(g2r, na.rm = T))/(max(g2r, na.rm = T)-min(g2r, na.rm = T))) %>% 
    ungroup()
  
  # optimize threshold and lag
  flower_freq_df_check_list<-vector(mode="list", length=length(site_list))
  for (r in 1:length(site_list)) { # select a region, here each site is treated as an individual region
    regionoi<-site_list[r]
    flower_freq_df_check_region_list<-vector(mode="list", length=nrow(thres_df_taxa))
    
    for (t in 1:nrow(thres_df_taxa)) { # select a threshold
      flower_freq_df_standard_subset<-flower_freq_df_standard %>% 
        filter(site==regionoi) %>%
        filter(direction==thres_df_taxa$direction[t],
               thres==thres_df_taxa$threshold[t]) %>% 
        group_by(site, year) %>% 
        ungroup()
      sample_size<-flower_freq_df_standard_subset %>% filter(!is.na(pollen), pollen>0) %>% nrow()
      if (sample_size>=5*4) { # only do tuning when there are more than 20 none-zero pollen count. skip the taxa and site otherwise.
        pollen_sm_ts<- flower_freq_df_standard_subset %>% pull (pollen_sm) # smoothed pollen count, for tuning
        pollen_ts<- flower_freq_df_standard_subset %>% pull (pollen) # pollen count, for calculating accuracy
        
        pollen_clim_ts<- flower_freq_df_standard_subset %>% pull (pollen_clim) # climatology
        rmse_clim<-sqrt(mean((pollen_clim_ts-pollen_ts)^2, na.rm=T)) # rmse between climatology and pollen count
        
        lags_list<- -200:200 # possible lags to try
        flower_freq_df_check_thres_list<-
          foreach (l = 1:length(lags_list),
                   .packages = c("tidyverse")) %dopar% {
                     lag=lags_list[l]
                     if (lag<0) {
                       flower_freq_df_standard_subset_lag<- flower_freq_df_standard_subset %>% mutate(freq_sm=lead(freq_sm,n=-lag))  %>% mutate(freq_sm=replace_na(freq_sm, 0)) # shift leafing phenology earlier by "lag" days, fill the NA with 0
                     } else if (lag==0) {
                       flower_freq_df_standard_subset_lag<-flower_freq_df_standard_subset  %>% mutate(freq_sm=replace_na(freq_sm, 0))
                     } else if (lag>0) {
                       flower_freq_df_standard_subset_lag<-flower_freq_df_standard_subset %>% mutate(freq_sm=lag(freq_sm,n=lag)) %>% mutate(freq_sm=replace_na(freq_sm, 0)) # shift leafing phenology later by "lag" days, fill the NA with 0
                     }
                     freq_ts_lag<- flower_freq_df_standard_subset_lag %>% pull (freq_sm)
                     rmse<-sqrt(mean((freq_ts_lag-pollen_sm_ts)^2, na.rm=T)) # rmse between remotely-sensed flowering phenology and smoothed pollen count
                     rmse_ps<-sqrt(mean((freq_ts_lag-pollen_ts)^2, na.rm=T)) # rmse between remotely-sensed flowering phenology and pollen count
                     
                     print(paste0("region ", r, ", threshold ", t, ", lag ", l))
                     
                     data.frame(direction=thres_df_taxa$direction[t],thres=thres_df_taxa$threshold[t],lag=lag, rmse=rmse,rmse_ps=rmse_ps, rmse_clim=rmse_clim)
                   }
        flower_freq_df_check_region_list[[t]]<-bind_rows(flower_freq_df_check_thres_list) %>% 
          arrange(rmse) %>% # choose the lag giving the smallest rmse in the threshold
          head(1)
      } else {
        flower_freq_df_check_region_list[[t]]<-data.frame(thres=numeric(0),lag=numeric(0), rmse=numeric(0), rmse_ps=numeric(0),rmse_clim=numeric(0))
      }
    }
    flower_freq_df_check_list[[r]]<-bind_rows(flower_freq_df_check_region_list) %>% 
      mutate(region=regionoi)  %>%
      arrange((rmse))
  }
  flower_freq_df_check<-bind_rows(flower_freq_df_check_list)
  # flower_freq_df_check
  write_rds(flower_freq_df_check,paste0(output_path,"accuracy check.rds") )
  
  best_thres<-flower_freq_df_check %>% 
    group_by(direction, thres) %>% 
    summarise(rmse=median(rmse)) %>% # median rmse for each threshold
    arrange(rmse) %>% 
    head(1) %>% # keep threshold giving the smallest median rmse
    dplyr::select(direction,thres)
  
  # flower_freq_df_check %>% filter(direction==best_thres$direction[1],
  #                                 thres==best_thres$thres[1])
  
  # getting time series with best threshold and lag
  flower_freq_df_standard_best_list<-vector(mode="list", length=length(site_list))
  for (r in 1:length(site_list)) {
    regionoi<-site_list[r]
    lagoi<-flower_freq_df_check %>% filter(direction==best_thres$direction,thres==best_thres$thres, region==regionoi) %>% pull(lag)
    if (length(lagoi)>0) {
      flower_freq_df_standard_best<-flower_freq_df_standard %>% 
        filter(site==regionoi) %>% 
        filter(direction==best_thres$direction,
               thres == best_thres$thres) %>%
        ungroup() %>%
        group_by(site, year)
      
      if (lagoi<0) {
        flower_freq_df_standard_best<- flower_freq_df_standard_best %>% mutate(freq_sm=lead(freq_sm,n=-lagoi)) %>% mutate(freq_sm=replace_na(freq_sm, 0))
      } else if (lagoi==0) {
        flower_freq_df_standard_best<- flower_freq_df_standard_best %>% mutate(freq_sm=replace_na(freq_sm, 0))
      } else if (lagoi>0) {
        flower_freq_df_standard_best<- flower_freq_df_standard_best %>% mutate(freq_sm=lag(freq_sm,n=lagoi)) %>% mutate(freq_sm=replace_na(freq_sm, 0))
      }  
      
      flower_freq_df_standard_best_list[[r]]<-flower_freq_df_standard_best %>% mutate(lag=lagoi)
    }
  }
  flower_freq_df_standard_best<-bind_rows(flower_freq_df_standard_best_list)
  
  # make plots
  flower_freq_comp<-ggplot(flower_freq_df_standard_best)+
    geom_point(aes(x=doy, y=npn, col="flower observation (USA-NPN)"), alpha=0.5)+
    geom_point(aes(x=doy, y=pollen, col="pollen count (NAB)"))+
    geom_line(aes(x=doy, y=pollen_clim, col="pollen count (NAB)"),alpha=0.5, lwd=1)+
    geom_point(aes(x=doy, y=evi, col="EVI (PS)"), alpha=0.2)+
    geom_line(aes(x=doy, y=freq_sm, col="flowering frequency"), lwd=1)+
    theme_classic()+
    facet_wrap(.~paste0(sitename, " (Lag: ", lag, ")")*year, ncol=4)+
    scale_color_manual(values=cols)+
    theme(legend.position="bottom")+
    theme(legend.title = element_blank())+
    ylab("")+
    ggtitle(paste0("Taxa: ",taxaoi," (Threshold: ",best_thres$direction, " ",best_thres$thres, ")"))
  flower_freq_comp
  jpeg(paste0(output_path, "flower frequency compared with other data.jpg"),
            height = 3200, width = 3200, res=300)
  print(flower_freq_comp)
  dev.off()
  
  flower_freq_corr<-ggplot(flower_freq_df_standard_best %>% mutate(year=as.factor(year)))+
    geom_point(aes(x=freq_sm, y=pollen , group=year, col=year))+
    geom_smooth(aes(x=freq_sm, y=pollen , group=year, col=year), method="lm", se=F, lwd=0.5)+
    geom_smooth(aes(x=freq_sm, y=pollen), method="lm")+
    theme_classic()+
    facet_wrap(.~sitename, ncol=4)+
    coord_equal()+
    xlim(0, 1)+
    ylim(0, 1)+
    ylab("pollen count^(1/2)")+
    xlab("flowering frequency")
  flower_freq_corr
  jpeg(paste0(output_path, "flower frequency and pollen count correlation.jpg"),
            height = 2400, width = 3200, res=300)
  print(flower_freq_corr)
  dev.off()
  
  across_site_and_year<-ggplot(flower_freq_df_standard_best %>%  
                                 mutate(year=as.factor(year)))+
    geom_point(aes(x=doy, y=pollen , group=year, col=year))+
    geom_line(aes(x=doy, y=freq_sm, group=year, col=year))+
    facet_wrap(.~paste0(sitename, " (Lag: ", lag, ")"), ncol=1)+
    theme_classic()+
    ylab("")+
    ggtitle(paste0("Taxa: ",taxaoi," (Threshold: ",best_thres$direction, " ",best_thres$thres, ")"))
  across_site_and_year
  
  jpeg(paste0(output_path, "phenology across site and year.jpg"),
            height = 3200, width = 3200, res=300)
  print(across_site_and_year)
  dev.off()
}
stopCluster(cl)
```

## Results
Prepare for Shiny app by copying result figures to the current folder. Shiny app code is in ./shinyapp/app.R. Needs to deploy app once every time results are changed.
```{r, eval=FALSE}
for (taxaoi in taxa_list) {
  files<-list.files(paste0("/raid/users/ysong67/GitHub/phenology/RS4flower/output/data/", taxaoi), pattern = "*.jpg", recursive = T, full.names = T)
  path_local<-paste0("/raid/users/ysong67/GitHub/RS4flower/shinyapp/result_figs/", taxaoi)
  dir.create(path_local, recursive = T)
  file.copy(from=files, to=path_local, 
          overwrite = TRUE, recursive = TRUE, 
          copy.mode = TRUE)
}
deployApp(appDir = "/raid/users/ysong67/GitHub/RS4flower/shinyapp", lint = F, account = "yiluansong", server = "shinyapps.io", appName = "RS4Flower_result", upload = T, forceUpdate = T)
```

Display results in a Shiny app.
```{r, eval=TRUE, cache=FALSE}
knitr::include_app("https://yiluansong.shinyapps.io/RS4flower_result/", height="600px")
```

Compare accuracy with climatology.
```{r, eval=TRUE}
flower_freq_df_check_list<-vector(mode="list") 
for (taxaoi in taxa_list) {
  output_path<-paste0("/raid/users/ysong67/GitHub/phenology/RS4flower/output/data/", taxaoi,"/")
  flower_freq_df_check_list[[taxaoi]]<-read_rds(paste0(output_path,"accuracy check.rds")) %>% 
    mutate(taxa=taxaoi)
}
flower_freq_df_check<-bind_rows(flower_freq_df_check_list)
best_thres<-flower_freq_df_check %>% group_by(taxa, thres) %>% summarise(rmse=median(rmse)) %>% arrange(rmse) %>% slice(1) %>% dplyr::select(taxa, thres)

accuracy_df<-flower_freq_df_check %>% 
  right_join(best_thres, by=c("taxa", "thres")) %>% 
  left_join(meta_df %>% dplyr::select(site, sitename), by=c("region"="site"))

# accuracy_df %>% 
#   dplyr::select(taxa, site=region, sitename, direction, thres, lag)

ggplot(accuracy_df)+
  geom_point(aes(x=region, y=rmse_ps), col="dark blue")+
  geom_point(aes(x=region, y=rmse_clim), col="dark red")+
  facet_wrap(.~taxa)+
  ylab("RMSE")+
  theme_classic()

accuracy_df %>% 
  mutate(rmse_diff=rmse_clim-rmse_ps) %>% 
  drop_na() %>% 
  group_by(taxa) %>% 
  summarize (min=min(rmse_diff),
             max=max(rmse_diff),
             mean=mean(rmse_diff),
             median=median(rmse_diff),
             proportion=sum(rmse_diff>0)/n()) %>% 
  ungroup()
```
