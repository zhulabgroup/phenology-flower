# Match pollen phenology with leafing phenology
Conceptual figure.
```{r, eval=TRUE}
source("code/match_concept.R")
p_conceptual
```

## Characterize leafing phenology for all taxa and cities
```{r, eval=FALSE}
source("code/match_doy.R")
```

## Tune threshold and time lag with pollen data
```{r, eval=FALSE}
cl <- makeCluster(20, outfile = "")
registerDoSNOW(cl)
for (taxaoi in taxa_list) {
  taxaoi_short <- str_split(taxaoi, " ", simplify = T)[1]
  flower_window <- seq(flower_window_df %>% filter(taxa == taxaoi) %>% pull(start),
    flower_window_df %>% filter(taxa == taxaoi) %>% pull(end),
    by = 1
  )
  if (taxaoi %in% c("Ambrosia", "Ulmus late")) {
    thres_df_taxa <- thres_df %>% filter(direction == "down")
  } else if (taxaoi == "Poaceae early") {
    thres_df_taxa <- thres_df %>% filter(threshold >= 0.5 | direction == "up")
  } else if (taxaoi == "Poaceae late") {
    thres_df_taxa <- thres_df %>% filter(threshold >= 0.5 | direction == "down")
  } else {
    thres_df_taxa <- thres_df %>% filter(direction == "up")
  }

  output_path <- paste0("./data/output/", taxaoi, "/")

  # read in leafing phenology data
  flower_doy_df <- read_rds(paste0(output_path, "flowering day of year.rds"))
  flower_freq_df <- read_rds(paste0(output_path, "flowering frequency.rds"))

  # standardize all data to be between 0 and 1
  flower_freq_df_standard <- flower_freq_df %>%
    mutate(pollen = pollen %>% sqrt()) %>%
    mutate(pollen_sm = pollen_sm %>% sqrt()) %>%
    mutate(pollen_clim = pollen_clim %>% sqrt()) %>%
    group_by(site, sitename, thres) %>%
    mutate(freq = (freq - min(freq, na.rm = T)) / (max(freq, na.rm = T) - min(freq, na.rm = T))) %>%
    mutate(freq_sm = (freq_sm - min(freq_sm, na.rm = T)) / (max(freq_sm, na.rm = T) - min(freq_sm, na.rm = T))) %>%
    mutate(pollen = (pollen - min(pollen, na.rm = T)) / (max(pollen, na.rm = T) - min(pollen, na.rm = T))) %>%
    mutate(pollen_clim = (pollen_clim - min(pollen_sm, na.rm = T)) / (max(pollen_sm, na.rm = T) - min(pollen_sm, na.rm = T))) %>%
    mutate(pollen_sm = (pollen_sm - min(pollen_sm, na.rm = T)) / (max(pollen_sm, na.rm = T) - min(pollen_sm, na.rm = T))) %>%
    mutate(npn = (npn - min(npn, na.rm = T)) / (max(npn, na.rm = T) - min(npn, na.rm = T))) %>%
    mutate(evi = (evi - min(evi, na.rm = T)) / (max(evi, na.rm = T) - min(evi, na.rm = T))) %>%
    mutate(g2r = (g2r - min(g2r, na.rm = T)) / (max(g2r, na.rm = T) - min(g2r, na.rm = T))) %>%
    ungroup()

  # optimize threshold and lag
  flower_freq_df_check_list <- vector(mode = "list", length = length(site_list))
  for (r in 1:length(site_list)) { # select a region, here each site is treated as an individual region
    regionoi <- site_list[r]
    flower_freq_df_check_region_list <- vector(mode = "list", length = nrow(thres_df_taxa))

    for (t in 1:nrow(thres_df_taxa)) { # select a threshold
      flower_freq_df_standard_subset <- flower_freq_df_standard %>%
        filter(site == regionoi) %>%
        filter(
          direction == thres_df_taxa$direction[t],
          thres == thres_df_taxa$threshold[t]
        ) %>%
        group_by(site, year) %>%
        ungroup()
      sample_size <- flower_freq_df_standard_subset %>%
        filter(!is.na(pollen), pollen > 0) %>%
        nrow()
      if (sample_size >= 5 * 4) { # only do tuning when there are more than 20 none-zero pollen count. skip the taxa and site otherwise.
        pollen_sm_ts <- flower_freq_df_standard_subset %>% pull(pollen_sm) # smoothed pollen count, for tuning
        pollen_ts <- flower_freq_df_standard_subset %>% pull(pollen) # pollen count, for calculating accuracy

        pollen_clim_ts <- flower_freq_df_standard_subset %>% pull(pollen_clim) # climatology
        rmse_clim <- sqrt(mean((pollen_clim_ts - pollen_ts)^2, na.rm = T)) # rmse between climatology and pollen count

        lags_list <- -200:200 # possible lags to try
        flower_freq_df_check_thres_list <-
          foreach(
            l = 1:length(lags_list),
            .packages = c("tidyverse")
          ) %dopar% {
            lag <- lags_list[l]
            if (lag < 0) {
              flower_freq_df_standard_subset_lag <- flower_freq_df_standard_subset %>%
                mutate(freq_sm = lead(freq_sm, n = -lag)) %>%
                mutate(freq_sm = replace_na(freq_sm, 0)) # shift leafing phenology earlier by "lag" days, fill the NA with 0
            } else if (lag == 0) {
              flower_freq_df_standard_subset_lag <- flower_freq_df_standard_subset %>% mutate(freq_sm = replace_na(freq_sm, 0))
            } else if (lag > 0) {
              flower_freq_df_standard_subset_lag <- flower_freq_df_standard_subset %>%
                mutate(freq_sm = lag(freq_sm, n = lag)) %>%
                mutate(freq_sm = replace_na(freq_sm, 0)) # shift leafing phenology later by "lag" days, fill the NA with 0
            }
            freq_ts_lag <- flower_freq_df_standard_subset_lag %>% pull(freq_sm)
            rmse <- sqrt(mean((freq_ts_lag - pollen_sm_ts)^2, na.rm = T)) # rmse between remotely-sensed flowering phenology and smoothed pollen count
            rmse_ps <- sqrt(mean((freq_ts_lag - pollen_ts)^2, na.rm = T)) # rmse between remotely-sensed flowering phenology and pollen count

            print(paste0("region ", r, ", threshold ", t, ", lag ", l))

            data.frame(direction = thres_df_taxa$direction[t], thres = thres_df_taxa$threshold[t], lag = lag, rmse = rmse, rmse_ps = rmse_ps, rmse_clim = rmse_clim)
          }
        flower_freq_df_check_region_list[[t]] <- bind_rows(flower_freq_df_check_thres_list) %>%
          arrange(rmse) %>% # choose the lag giving the smallest rmse in the threshold
          head(1)
      } else {
        flower_freq_df_check_region_list[[t]] <- data.frame(thres = numeric(0), lag = numeric(0), rmse = numeric(0), rmse_ps = numeric(0), rmse_clim = numeric(0))
      }
    }
    flower_freq_df_check_list[[r]] <- bind_rows(flower_freq_df_check_region_list) %>%
      mutate(region = regionoi) %>%
      arrange((rmse))
  }
  flower_freq_df_check <- bind_rows(flower_freq_df_check_list)
  # flower_freq_df_check
  write_rds(flower_freq_df_check, paste0(output_path, "accuracy check.rds"))

  best_thres <- flower_freq_df_check %>%
    group_by(direction, thres) %>%
    summarise(rmse = median(rmse)) %>% # median rmse for each threshold
    arrange(rmse) %>%
    head(1) %>% # keep threshold giving the smallest median rmse
    dplyr::select(direction, thres)

  # flower_freq_df_check %>% filter(direction==best_thres$direction[1],
  #                                 thres==best_thres$thres[1])

  # getting time series with best threshold and lag
  flower_freq_df_standard_best_list <- vector(mode = "list", length = length(site_list))
  for (r in 1:length(site_list)) {
    regionoi <- site_list[r]
    lagoi <- flower_freq_df_check %>%
      filter(direction == best_thres$direction, thres == best_thres$thres, region == regionoi) %>%
      pull(lag)
    if (length(lagoi) > 0) {
      flower_freq_df_standard_best <- flower_freq_df_standard %>%
        filter(site == regionoi) %>%
        filter(
          direction == best_thres$direction,
          thres == best_thres$thres
        ) %>%
        ungroup() %>%
        group_by(site, year)

      if (lagoi < 0) {
        flower_freq_df_standard_best <- flower_freq_df_standard_best %>%
          mutate(freq_sm = lead(freq_sm, n = -lagoi)) %>%
          mutate(freq_sm = replace_na(freq_sm, 0))
      } else if (lagoi == 0) {
        flower_freq_df_standard_best <- flower_freq_df_standard_best %>% mutate(freq_sm = replace_na(freq_sm, 0))
      } else if (lagoi > 0) {
        flower_freq_df_standard_best <- flower_freq_df_standard_best %>%
          mutate(freq_sm = lag(freq_sm, n = lagoi)) %>%
          mutate(freq_sm = replace_na(freq_sm, 0))
      }

      flower_freq_df_standard_best_list[[r]] <- flower_freq_df_standard_best %>% mutate(lag = lagoi)
    }
  }
  flower_freq_df_standard_best <- bind_rows(flower_freq_df_standard_best_list)

  # make plots
  flower_freq_comp <- ggplot(flower_freq_df_standard_best) +
    geom_point(aes(x = doy, y = npn, col = "flower observation (USA-NPN)"), alpha = 0.5) +
    geom_point(aes(x = doy, y = pollen, col = "pollen concentration (NAB)")) +
    geom_line(aes(x = doy, y = pollen_clim, col = "pollen concentration (NAB)"), alpha = 0.5, lwd = 1) +
    geom_point(aes(x = doy, y = evi, col = "enhanced vegetation index (PS)"), alpha = 0.2) +
    geom_line(aes(x = doy, y = freq_sm, col = "flowering frequency"), lwd = 1) +
    theme_classic() +
    facet_wrap(. ~ paste0(sitename, " (Lag: ", lag, ")") * year, ncol = 4) +
    scale_color_manual(values = cols) +
    theme(legend.position = "bottom") +
    theme(legend.title = element_blank()) +
    ylab("") +
    ggtitle(paste0("Taxa: ", taxaoi, " (Threshold: ", best_thres$direction, " ", best_thres$thres, ")"))
  flower_freq_comp
  jpeg(paste0(output_path, "flower frequency compared with other data.jpg"),
    height = 3200, width = 3200, res = 300
  )
  print(flower_freq_comp)
  dev.off()

  flower_freq_corr <- ggplot(flower_freq_df_standard_best %>% mutate(year = as.factor(year))) +
    geom_point(aes(x = freq_sm, y = pollen, group = year, col = year)) +
    geom_smooth(aes(x = freq_sm, y = pollen, group = year, col = year), method = "lm", se = F, lwd = 0.5) +
    geom_smooth(aes(x = freq_sm, y = pollen), method = "lm") +
    theme_classic() +
    facet_wrap(. ~ sitename, ncol = 4) +
    coord_equal() +
    xlim(0, 1) +
    ylim(0, 1) +
    ylab("pollen count^(1/2)") +
    xlab("flowering frequency")
  flower_freq_corr
  jpeg(paste0(output_path, "flower frequency and pollen count correlation.jpg"),
    height = 2400, width = 3200, res = 300
  )
  print(flower_freq_corr)
  dev.off()

  across_site_and_year <- ggplot(flower_freq_df_standard_best %>%
    mutate(year = as.factor(year))) +
    geom_point(aes(x = doy, y = pollen, group = year, col = year)) +
    geom_line(aes(x = doy, y = freq_sm, group = year, col = year)) +
    facet_wrap(. ~ paste0(sitename, " (Lag: ", lag, ")"), ncol = 1) +
    theme_classic() +
    ylab("") +
    ggtitle(paste0("Taxa: ", taxaoi, " (Threshold: ", best_thres$direction, " ", best_thres$thres, ")"))
  across_site_and_year

  jpeg(paste0(output_path, "phenology across site and year.jpg"),
    height = 3200, width = 3200, res = 300
  )
  print(across_site_and_year)
  dev.off()
}
stopCluster(cl)
```

## Results
Prepare for Shiny app by copying result figures to the current folder. Shiny app code is in ./shinyapp/app.R. Needs to deploy app once every time results are changed.
```{r, eval=TRUE, echo=FALSE}
rsconnect::setAccountInfo(name='yiluansong',
			  token='095CAA728048A2F23867FA44B16C92F8',
			  secret='xZ99vo7in7UIKIcAG0kBoFi8adeeBu0xTNef0dLd')
```

```{r, eval=FALSE}
for (taxaoi in taxa_list) {
  files <- list.files(paste0("./data/output/", taxaoi), pattern = "*.jpg", recursive = T, full.names = T)
  path_local <- paste0("./shinyapp/result_figs/", taxaoi)
  dir.create(path_local, recursive = T)
  file.copy(
    from = files, to = path_local,
    overwrite = TRUE, recursive = TRUE,
    copy.mode = TRUE
  )
}
deployApp(appDir = "./shinyapp", lint = F, account = "yiluansong", server = "shinyapps.io", appName = "RS4Flower_result", upload = T, forceUpdate = T)
```

Display results in a Shiny app.
```{r, eval=TRUE, cache=FALSE}
knitr::include_app("https://yiluansong.shinyapps.io/RS4flower_result/", height = "600px")
```

Visualize matching results for all taxa in New York.
```{r, eval=TRUE}
siteoi <- "NY"
flower_freq_df_allsites_list <- vector(mode = "list")
for (t in 1:length(taxa_list)) {
  taxaoi <- taxa_list[t]
  output_path <- paste0("./data/output/", taxaoi, "/")

  flower_freq_df <- read_rds(paste0(output_path, "flowering frequency.rds"))

  # standardize all data to be between 0 and 1
  flower_freq_df_standard <- flower_freq_df %>%
    mutate(pollen = pollen %>% sqrt()) %>%
    mutate(pollen_sm = pollen_sm %>% sqrt()) %>%
    mutate(pollen_clim = pollen_clim %>% sqrt()) %>%
    group_by(site, sitename, thres) %>%
    mutate(freq = (freq - min(freq, na.rm = T)) / (max(freq, na.rm = T) - min(freq, na.rm = T))) %>%
    mutate(freq_sm = (freq_sm - min(freq_sm, na.rm = T)) / (max(freq_sm, na.rm = T) - min(freq_sm, na.rm = T))) %>%
    mutate(pollen = (pollen - min(pollen, na.rm = T)) / (max(pollen, na.rm = T) - min(pollen, na.rm = T))) %>%
    mutate(pollen_clim = (pollen_clim - min(pollen_sm, na.rm = T)) / (max(pollen_sm, na.rm = T) - min(pollen_sm, na.rm = T))) %>%
    mutate(pollen_sm = (pollen_sm - min(pollen_sm, na.rm = T)) / (max(pollen_sm, na.rm = T) - min(pollen_sm, na.rm = T))) %>%
    mutate(npn = (npn - min(npn, na.rm = T)) / (max(npn, na.rm = T) - min(npn, na.rm = T))) %>%
    mutate(evi = (evi - min(evi, na.rm = T)) / (max(evi, na.rm = T) - min(evi, na.rm = T))) %>%
    mutate(g2r = (g2r - min(g2r, na.rm = T)) / (max(g2r, na.rm = T) - min(g2r, na.rm = T))) %>%
    ungroup()

  flower_freq_df_check <- read_rds(paste0(output_path, "accuracy check.rds"))

  best_thres <- flower_freq_df_check %>%
    group_by(direction, thres) %>%
    summarise(rmse = median(rmse)) %>% # median rmse for each threshold
    arrange(rmse) %>%
    head(1) %>% # keep threshold giving the smallest median rmse
    dplyr::select(direction, thres)

  # getting time series with best threshold and lag
  flower_freq_df_standard_best_list <- vector(mode = "list", length = length(site_list))
  for (r in 1:length(site_list)) {
    regionoi <- site_list[r]
    lagoi <- flower_freq_df_check %>%
      filter(direction == best_thres$direction, thres == best_thres$thres, region == regionoi) %>%
      pull(lag)
    if (length(lagoi) > 0) {
      flower_freq_df_standard_best <- flower_freq_df_standard %>%
        filter(site == regionoi) %>%
        filter(
          direction == best_thres$direction,
          thres == best_thres$thres
        ) %>%
        ungroup() %>%
        group_by(site, year)

      if (lagoi < 0) {
        flower_freq_df_standard_best <- flower_freq_df_standard_best %>%
          mutate(freq_sm = lead(freq_sm, n = -lagoi)) %>%
          mutate(freq_sm = replace_na(freq_sm, 0))
      } else if (lagoi == 0) {
        flower_freq_df_standard_best <- flower_freq_df_standard_best %>% mutate(freq_sm = replace_na(freq_sm, 0))
      } else if (lagoi > 0) {
        flower_freq_df_standard_best <- flower_freq_df_standard_best %>%
          mutate(freq_sm = lag(freq_sm, n = lagoi)) %>%
          mutate(freq_sm = replace_na(freq_sm, 0))
      }

      flower_freq_df_standard_best_list[[r]] <- flower_freq_df_standard_best %>% mutate(lag = lagoi)
    }
  }
  flower_freq_df_standard_best <- bind_rows(flower_freq_df_standard_best_list) %>%
    filter(site == siteoi) %>%
    filter(year == 2018) %>%
    mutate(taxa = taxaoi)

  flower_freq_df_allsites_list[[t]] <- flower_freq_df_standard_best
}
flower_freq_df_allsites <- bind_rows(flower_freq_df_allsites_list)

# make plots
flower_freq_comp_1city <- ggplot(flower_freq_df_allsites %>%
                                   filter(!taxa %in% c("Poaceae early", "Poaceae late", "Ambrosia")) %>%
  mutate(doy = as.Date(doy, origin = "2018-01-01")) %>%
  mutate(taxa_p = paste0(taxa, " (Threshold: ", thres %>% percent(), " green-", direction, ", Lag: ", lag, " days)")) %>%
  mutate(taxa_p = fct_relevel(taxa_p, levels = unique(taxa_p)))) +
  geom_point(aes(x = doy, y = npn, col = "flower observation (USA-NPN)"), alpha = 0.5) +
  geom_point(aes(x = doy, y = pollen, col = "pollen concentration (NAB)")) +
  # geom_line(aes(x=doy, y=pollen_clim, col="pollen count (NAB)"),alpha=0.5, lwd=1)+
  geom_point(aes(x = doy, y = evi, col = "enhanced vegetation index (PS)"), alpha = 0.05) +
  geom_line(aes(x = doy, y = freq_sm, col = "flowering frequency"), lwd = 1) +
  theme_classic() +
  facet_wrap(. ~ taxa_p, ncol = 3) +
  scale_color_manual(values = cols) +
  xlab("Day of year") +
  ylab("Standardized value") +
  # ggtitle(paste0("Site: ", siteoi,"  Year: ", yearoi,"  ID: ", idoi, "  Species: ", plant_sp))+
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    strip.background = element_rect(
      color = NA, fill = "grey"
    )
  ) +
  scale_x_date(date_labels = "%b", date_breaks = "3 month") +
  theme(legend.position = "bottom") +
  guides(col = guide_legend(title = ""))
# ggtitle(paste0("Taxa: ",taxaoi," (Threshold: ",best_thres$direction, " ",best_thres$thres, ")"))
flower_freq_comp_1city
```


Compare accuracy with climatology.
```{r, eval=TRUE}
flower_freq_df_check_list <- vector(mode = "list")
for (taxaoi in taxa_list) {
  output_path <- paste0("./data/output/", taxaoi, "/")
  flower_freq_df_check_list[[taxaoi]] <- read_rds(paste0(output_path, "accuracy check.rds")) %>%
    mutate(taxa = taxaoi)
}
flower_freq_df_check <- bind_rows(flower_freq_df_check_list)
best_thres <- flower_freq_df_check %>%
  group_by(taxa, direction, thres) %>%
  summarise(rmse = median(rmse)) %>%
  arrange(rmse) %>%
  slice(1) %>%
  dplyr::select(taxa, direction, thres)

accuracy_df <- flower_freq_df_check %>%
  right_join(best_thres, by = c("taxa", "direction", "thres")) %>%
  left_join(meta_df %>% dplyr::select(site, sitename), by = c("region" = "site"))

# accuracy_df %>%
#   dplyr::select(taxa, site=region, sitename, direction, thres, lag)

ggplot(accuracy_df) +
  geom_point(aes(x = region, y = rmse_ps), col = "dark blue", cex = 2) +
  geom_point(aes(x = region, y = rmse_clim), col = "dark red") +
  facet_wrap(. ~ taxa) +
  ylab("RMSE") +
  theme_classic()

accuracy_df %>%
  mutate(rmse_diff = rmse_ps - rmse_clim) %>%
  drop_na() %>%
  group_by(taxa) %>%
  summarize(
    min = min(rmse_diff),
    max = max(rmse_diff),
    mean = mean(rmse_diff),
    median = median(rmse_diff),
    proportion = sum(rmse_diff < 0) / n()
  ) %>%
  ungroup()

accuracy_df %>%
  filter(!taxa %in% c("Poaceae early", "Poaceae late", "Ambrosia")) %>%
  group_by(taxa) %>%
  summarize(
    rmse_clim = median(rmse_clim),
    rmse_ps = median(rmse_ps)
  ) %>%
  ungroup() %>%
  mutate(taxa = as.factor(taxa)) %>%
  mutate(taxa = fct_relevel(taxa, levels = taxa_list)) %>%
  arrange(taxa) %>%
  mutate(diff = (rmse_ps - rmse_clim) / rmse_clim)

accuracy_df %>%
  filter(!taxa %in% c("Poaceae early", "Poaceae late", "Ambrosia")) %>%
  group_by(sitename) %>%
  summarize(
    rmse_clim = median(rmse_clim),
    rmse_ps = median(rmse_ps)
  ) %>%
  ungroup() %>%
  rename(city = sitename) %>%
  mutate(city = fct_relevel(city, levels = site_lat)) %>%
  mutate(diff = (rmse_ps - rmse_clim) / rmse_clim)
```
